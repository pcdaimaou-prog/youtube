name: "MC-AI-Architect-Ultimate"
on: [workflow_dispatch]

permissions:
  contents: write

jobs:
  # 司令塔ジョブ
  server:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Start Management Server
        run: |
          npm install express localtunnel node-fetch@2 minimist
          # 1時間(3600秒)でタイムアウト
          timeout 3600s node main.js --mode server

  # AIボットジョブ (10並列)
  bot:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        pair_id: [1, 2, 3, 4, 5]
        role: ["A", "B"]
    steps:
      - uses: actions/checkout@v4
      - name: Setup Ollama
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve & sleep 10 && ollama pull llama3:8b-instruct-q4_0
      - name: Run AI Bot
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npm install mineflayer node-fetch@2 minimist
          node main.js --mode bot --pair ${{ matrix.pair_id }} --role ${{ matrix.role }} --name "Bot-${{ matrix.pair_id }}-${{ matrix.role }}"
